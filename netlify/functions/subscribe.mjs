export async function handler(event){try{if(event.httpMethod!=='POST')return{statusCode:405,body:'Method Not Allowed'};const d=JSON.parse(event.body||'{}');const{firstName,lastName,email,airline,base,phone,consent}=d;if(!consent||!email)return{statusCode:400,body:'Missing consent or email'};const apiKey=process.env.MAILCHIMP_API_KEY;const dc=process.env.MAILCHIMP_DC;const listId=process.env.MAILCHIMP_LIST_ID;if(!apiKey||!dc||!listId)return{statusCode:500,body:'Missing Mailchimp env vars'};const resp=await fetch(`https://${dc}.api.mailchimp.com/3.0/lists/${listId}/members`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`apikey ${apiKey}`},body:JSON.stringify({email_address:email,status:'pending',merge_fields:{FNAME:firstName,LNAME:lastName,AIRLINE:airline,BASE:base,PHONE:phone}})});if(resp.status===400){const j=await resp.json();if(j.title==='Member Exists'||j.title==='Forgotten Email Not Subscribed'){return{statusCode:200,body:JSON.stringify({status:'ok'})}}return{statusCode:400,body:JSON.stringify(j)}}if(!resp.ok){const t=await resp.text();return{statusCode:502,body:`Mailchimp error: ${t}`}}return{statusCode:200,body:JSON.stringify({status:'ok'})}}catch(e){return{statusCode:500,body:'Server error'}}}